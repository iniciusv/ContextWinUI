<UserControl
    x:Class="ContextWinUI.Views.AiControlPanel"
    x:Name="PanelRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:ContextWinUI.Models"
    xmlns:converters="using:ContextWinUI.Converters"
    mc:Ignorable="d">

	<UserControl.Resources>
		<converters:NullToVisibilityConverter x:Key="NullToCollapsedConverter" Invert="False"/>
	</UserControl.Resources>

	<Grid BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" 
          BorderThickness="0,0,1,0"
          Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<StackPanel Grid.Row="0" Spacing="8" Padding="12">
			<TextBlock Text="AI Input (Paste code or prompt)" Style="{StaticResource BodyStrongTextBlockStyle}"/>
			<TextBox Text="{Binding RawInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     PlaceholderText="Paste AI result here..."
                     AcceptsReturn="True" Height="120" FontFamily="Consolas"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"/>
		</StackPanel>

		<Grid Grid.Row="1" ColumnDefinitions="*, Auto" Padding="12,0,12,12">
			<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Grid.Column="1">
				<Button Content="Clear" Command="{Binding ClearCommand}"/>
				<Button Content="Process" Style="{StaticResource AccentButtonStyle}" Command="{Binding ProcessInputCommand}">
					<Button.KeyboardAccelerators>
						<KeyboardAccelerator Key="Enter" Modifiers="Control"/>
					</Button.KeyboardAccelerators>
				</Button>
			</StackPanel>
		</Grid>

		<Grid Grid.Row="2" Padding="12,0">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="*"/>
			</Grid.RowDefinitions>

			<TextBlock Text="Detected Changes" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,8"/>

			<ListView Grid.Row="1" ItemsSource="{Binding DetectedChanges}" SelectedItem="{Binding SelectedChange, Mode=TwoWay}" SelectionMode="Single">
				<ListView.ItemTemplate>
					<DataTemplate x:DataType="models:ProposedFileChange">
						<Grid Padding="0,8">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>

							<CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}" VerticalAlignment="Top" Margin="0,0,12,0"/>

							<StackPanel Grid.Column="1" Spacing="2">
								<TextBlock Text="{x:Bind FileName}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" ToolTipService.ToolTip="{x:Bind FilePath}"/>
								<StackPanel Orientation="Horizontal" Spacing="8">
									<TextBlock Text="{x:Bind Status}" Foreground="{x:Bind StatusColor}" FontSize="12"/>
									<TextBlock Text="{x:Bind ChangeSummary}" Foreground="Gray" FontSize="12"/>
								</StackPanel>

								<ItemsControl ItemsSource="{x:Bind ValidationWarnings}">
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding}" Foreground="Orange" FontSize="10" TextWrapping="Wrap"/>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
							</StackPanel>
						</Grid>
					</DataTemplate>
				</ListView.ItemTemplate>
			</ListView>
		</Grid>

		<StackPanel Grid.Row="3" Padding="12" Background="{ThemeResource LayerFillColorDefaultBrush}">
			<Button Content="Apply Selected Changes" HorizontalAlignment="Stretch" Style="{StaticResource AccentButtonStyle}" Command="{Binding ApplySelectedChangesCommand}"/>
		</StackPanel>

		<Expander Grid.Row="4" Header="History / Revert" IsExpanded="True" Margin="12,0,12,12" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
			<ListView ItemsSource="{Binding History}" MaxHeight="200">
				<ListView.ItemTemplate>
					<DataTemplate x:DataType="models:ModificationHistoryEntry">
						<Grid Padding="0,4">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<TextBlock Text="{x:Bind TimeString}" Foreground="Gray" FontSize="11" VerticalAlignment="Center" Margin="0,0,8,0"/>
							<TextBlock Grid.Column="1" Text="{x:Bind FileName}" FontSize="12" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>

							<Button Grid.Column="2" Content="Undo" FontSize="10" Padding="4,2" Margin="4,0,0,0"
                                    Command="{Binding ElementName=PanelRoot, Path=ViewModel.RevertChangeCommand}"
                                    CommandParameter="{x:Bind}"/>
						</Grid>
					</DataTemplate>
				</ListView.ItemTemplate>
			</ListView>
		</Expander>
	</Grid>
</UserControl>