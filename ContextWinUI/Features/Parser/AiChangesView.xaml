<UserControl
    x:Class="ContextWinUI.Views.AiChangesView"
    x:Name="RootControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    
    xmlns:vm="using:ContextWinUI.ViewModels"
    xmlns:models="using:ContextWinUI.Models"
    xmlns:services="using:ContextWinUI.Services"
    xmlns:converters="using:ContextWinUI.Converters"
    
    mc:Ignorable="d">

	<UserControl.Resources>
		<converters:NullToVisibilityConverter x:Key="NullToCollapsedConverter" Invert="False"/>
		<converters:NullToVisibilityConverter x:Key="NullToVisibleConverter" Invert="True"/>

		<converters:DiffToColorConverter x:Key="DiffToColorConverter"/>
	</UserControl.Resources>

	<Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="450" MinWidth="300"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>

		<Grid Grid.Column="0" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" BorderThickness="0,0,1,0">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="*"/>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="Auto"/>
			</Grid.RowDefinitions>

			<StackPanel Grid.Row="0" Spacing="8" Padding="12">
				<TextBlock Text="Entrada da IA (Cole o código ou prompt)" 
                           Style="{StaticResource BodyStrongTextBlockStyle}"/>
				<TextBox Text="{x:Bind ViewModel.RawInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         PlaceholderText="Cole aqui o resultado da IA (ex: // ARQUIVO: Classe.cs ...)"
                         AcceptsReturn="True"
                         Height="120"
                         FontFamily="Consolas"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"/>
			</StackPanel>

			<Grid Grid.Row="1" ColumnDefinitions="*, Auto" Padding="12,0,12,12">
				<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Grid.Column="1">
					<Button Content="Limpar" Command="{x:Bind ViewModel.ClearCommand}"/>
					<Button Content="Processar" 
                            Style="{StaticResource AccentButtonStyle}"
                            Command="{x:Bind ViewModel.ProcessInputCommand}">
						<Button.KeyboardAccelerators>
							<KeyboardAccelerator Key="Enter" Modifiers="Control"/>
						</Button.KeyboardAccelerators>
					</Button>
				</StackPanel>
			</Grid>

			<Grid Grid.Row="2" Padding="12,0">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<TextBlock Text="Alterações Detectadas" 
                           Style="{StaticResource SubtitleTextBlockStyle}" 
                           Margin="0,0,0,8"/>

				<ListView Grid.Row="1"
                          ItemsSource="{x:Bind ViewModel.DetectedChanges, Mode=OneWay}"
                          SelectedItem="{x:Bind ViewModel.SelectedChange, Mode=TwoWay}"
                          SelectionMode="Single">
					<ListView.ItemTemplate>
						<DataTemplate x:DataType="models:ProposedFileChange">
							<Grid Padding="0,8">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="Auto"/>
									<ColumnDefinition Width="*"/>
								</Grid.ColumnDefinitions>

								<CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}" 
                                          VerticalAlignment="Top" 
                                          Margin="0,0,12,0"/>

								<StackPanel Grid.Column="1" Spacing="2">
									<TextBlock Text="{x:Bind FileName}" 
                                               FontWeight="SemiBold" 
                                               TextTrimming="CharacterEllipsis"
                                               ToolTipService.ToolTip="{x:Bind FilePath}"/>

									<StackPanel Orientation="Horizontal" Spacing="8">
										<TextBlock Text="{x:Bind Status}" 
                                                   Foreground="{x:Bind StatusColor}" 
                                                   FontSize="12"/>
										<TextBlock Text="|" Foreground="Gray" FontSize="12"/>
										<TextBlock Text="{x:Bind ChangeSummary}" 
                                                   Foreground="Gray" 
                                                   FontSize="12"/>
									</StackPanel>

									<ItemsControl ItemsSource="{x:Bind ValidationWarnings}">
										<ItemsControl.ItemTemplate>
											<DataTemplate>
												<TextBlock Text="{Binding}" 
                                                           Foreground="Orange" 
                                                           FontSize="10" 
                                                           TextWrapping="Wrap"/>
											</DataTemplate>
										</ItemsControl.ItemTemplate>
									</ItemsControl>
								</StackPanel>
							</Grid>
						</DataTemplate>
					</ListView.ItemTemplate>
				</ListView>
			</Grid>

			<StackPanel Grid.Row="3" Padding="12" Background="{ThemeResource LayerFillColorDefaultBrush}">
				<Button Content="Aplicar Alterações Selecionadas" 
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource AccentButtonStyle}"
                        Command="{x:Bind ViewModel.ApplySelectedChangesCommand}"/>
			</StackPanel>

			<Expander Grid.Row="4" 
                      Header="Histórico / Reverter" 
                      IsExpanded="True"
                      Margin="12,0,12,12"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Stretch">
				<ListView ItemsSource="{x:Bind ViewModel.History, Mode=OneWay}" 
                          MaxHeight="200">
					<ListView.ItemTemplate>
						<DataTemplate x:DataType="models:ModificationHistoryEntry">
							<Grid Padding="0,4">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="Auto"/>
									<ColumnDefinition Width="*"/>
									<ColumnDefinition Width="Auto"/>
								</Grid.ColumnDefinitions>

								<TextBlock Text="{x:Bind TimeString}" 
                                           Foreground="Gray" 
                                           FontSize="11" 
                                           VerticalAlignment="Center" 
                                           Margin="0,0,8,0"/>

								<TextBlock Grid.Column="1" 
                                           Text="{x:Bind FileName}" 
                                           FontSize="12" 
                                           VerticalAlignment="Center"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTipService.ToolTip="{x:Bind FilePath}"/>

								<Button Grid.Column="2" 
                                        Content="Desfazer" 
                                        FontSize="10"
                                        Padding="4,2"
                                        Margin="4,0,0,0"
                                        Command="{Binding ElementName=RootControl, Path=ViewModel.RevertChangeCommand}"
                                        CommandParameter="{x:Bind}"/>
							</Grid>
						</DataTemplate>
					</ListView.ItemTemplate>
					<ListView.Footer>
						<TextBlock Text="Fim do histórico recente." 
                                   FontSize="11" Foreground="Gray" 
                                   HorizontalAlignment="Center" Padding="8"/>
					</ListView.Footer>
				</ListView>
			</Expander>
		</Grid>

		<Grid Grid.Column="1" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="*"/>
			</Grid.RowDefinitions>

			<Grid Padding="16,8" Background="{ThemeResource LayerFillColorDefaultBrush}" 
                  BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
				<StackPanel Orientation="Horizontal" Spacing="8">
					<TextBlock Text="Revisão (Diff)" Style="{StaticResource BodyStrongTextBlockStyle}" VerticalAlignment="Center"/>
					<TextBlock Text="{x:Bind ViewModel.SelectedChange.FilePath, Mode=OneWay, TargetNullValue=''}" 
                               Foreground="Gray" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
				</StackPanel>
			</Grid>

			<ListView Grid.Row="1"
                      ItemsSource="{x:Bind ViewModel.DiffLines, Mode=OneWay}"
                      SelectionMode="None">

				<ListView.ItemContainerStyle>
					<Style TargetType="ListViewItem">
						<Setter Property="Padding" Value="0"/>
						<Setter Property="MinHeight" Value="20"/>
						<Setter Property="HorizontalContentAlignment" Value="Stretch"/>
						<Setter Property="VerticalContentAlignment" Value="Stretch"/>
					</Style>
				</ListView.ItemContainerStyle>

				<ListView.ItemTemplate>
					<DataTemplate x:DataType="services:DiffLine">
						<Grid>
							<Grid.Background>
								<Binding Path="Type" Converter="{StaticResource DiffToColorConverter}" ConverterParameter="Background"/>
							</Grid.Background>

							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="40"/>
								<ColumnDefinition Width="40"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>

							<TextBlock Text="{x:Bind OriginalLineNumber, TargetNullValue=''}" 
                                       Foreground="Gray" FontSize="11" 
                                       HorizontalAlignment="Right" Margin="0,0,8,0" 
                                       FontFamily="Consolas"/>

							<TextBlock Grid.Column="1" 
                                       Text="{x:Bind NewLineNumber, TargetNullValue=''}" 
                                       Foreground="Gray" FontSize="11" 
                                       HorizontalAlignment="Right" Margin="0,0,8,0" 
                                       FontFamily="Consolas"/>

							<TextBlock Grid.Column="2" 
                                       Text="{x:Bind Text}" 
                                       FontFamily="Consolas, Cascadia Code" 
                                       FontSize="13"
                                       TextWrapping="Wrap">
								<TextBlock.Foreground>
									<Binding Path="Type" Converter="{StaticResource DiffToColorConverter}" ConverterParameter="Foreground"/>
								</TextBlock.Foreground>
							</TextBlock>
						</Grid>
					</DataTemplate>
				</ListView.ItemTemplate>
			</ListView>

			<TextBlock Grid.Row="1" 
                       Text="Selecione um arquivo para ver as mudanças exatas." 
                       HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="Gray"
                       Visibility="{x:Bind ViewModel.SelectedChange, Converter={StaticResource NullToVisibleConverter}, Mode=OneWay}"/>
		</Grid>

		<Grid Grid.ColumnSpan="2" 
              Background="#80000000" 
              Visibility="{x:Bind ViewModel.IsProcessing, Mode=OneWay}">
			<ProgressRing IsActive="True" Width="60" Height="60"/>
		</Grid>

	</Grid>
</UserControl>