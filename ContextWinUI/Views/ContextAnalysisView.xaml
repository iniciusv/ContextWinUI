<UserControl
    x:Class="ContextWinUI.Views.ContextAnalysisView"
    x:Name="RootAnalysisView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ContextWinUI.Models"
    xmlns:components="using:ContextWinUI.Views.Components"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

	<Grid Background="{ThemeResource LayerFillColorDefaultBrush}">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<Grid Grid.Row="0" Padding="16,12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="Auto"/>
			</Grid.ColumnDefinitions>

			<Button Grid.Column="0" 
                    Content="&#xE72B;" 
                    FontFamily="Segoe MDL2 Assets"
                    Command="{x:Bind ContextViewModel.GoBackCommand}"
                    Visibility="{x:Bind ContextViewModel.CanGoBack, Mode=OneWay}"
                    ToolTipService.ToolTip="Voltar para análise anterior"
                    Background="Transparent"
                    BorderThickness="0"
                    Margin="0,0,8,0"
                    FontSize="16"
                    Height="32"
                    Width="32"
                    VerticalAlignment="Center"/>

			<StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center">
				<TextBlock Text="Análise" Style="{StaticResource SubtitleTextBlockStyle}"/>
				<TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12">
                    <Run Text="Sel:"/>
                    <Run Text="{x:Bind ContextViewModel.SelectedCount, Mode=OneWay}"/>
				</TextBlock>
			</StackPanel>

			<components:ExpandCollapseActions Grid.Column="2" 
                                              SyncFocusCommand="{x:Bind ContextViewModel.SyncFocusCommand}"
                                              ExpandAllCommand="{x:Bind ContextViewModel.ExpandAllCommand}"
                                              CollapseAllCommand="{x:Bind ContextViewModel.CollapseAllCommand}"
                                              Margin="0,0,8,0"/>

			<Button Grid.Column="3" Content="✕" Command="{x:Bind ContextViewModel.CloseCommand}" FontSize="16" Width="32" Height="32" Padding="0" VerticalAlignment="Center"/>
		</Grid>

		<components:SearchBar Grid.Row="1" 
                              SearchCommand="{x:Bind ContextViewModel.SearchCommand}" 
                              Margin="16,8,16,8"/>

		<TreeView Grid.Row="2" 
                  ItemsSource="{x:Bind ContextViewModel.ContextTreeItems, Mode=OneWay}" 
                  SelectionMode="Single"
                  ItemInvoked="TreeView_ItemInvoked">
			<TreeView.ItemTemplate>
				<DataTemplate x:DataType="models:FileSystemItem">
					<TreeViewItem ItemsSource="{x:Bind Children, Mode=OneWay}" 
                                  IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}"
                                  Visibility="{x:Bind Visibility, Mode=OneWay}">
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<CheckBox Grid.Column="0" 
                                      IsChecked="{x:Bind IsChecked, Mode=TwoWay}" 
                                      Command="{Binding ElementName=RootAnalysisView, Path=ContextViewModel.ItemCheckedCommand}"
                                      MinWidth="0" Padding="0" VerticalAlignment="Center" Margin="0,0,8,0"/>

							<FontIcon Grid.Column="1" Glyph="{x:Bind Icon}" FontSize="14" Foreground="{ThemeResource SystemAccentColor}" Margin="0,0,8,0"/>

							<TextBlock Grid.Column="2" Text="{x:Bind Name}" VerticalAlignment="Center" FontSize="13" TextTrimming="CharacterEllipsis"/>

							<Button Grid.Column="3" 
                                    Content="&#xE768;" 
                                    FontFamily="Segoe MDL2 Assets"
                                    FontSize="10"
                                    Padding="0"
                                    Width="24"
                                    Height="24"
                                    Margin="8,0,0,0"
                                    ToolTipService.ToolTip="Ver chamadas deste método"
                                    Visibility="{x:Bind MethodFlowVisibility, Mode=OneWay}"
                                    Command="{Binding ElementName=RootAnalysisView, Path=ContextViewModel.AnalyzeMethodFlowCommand}"
                                    CommandParameter="{x:Bind}"/>

							<Button Grid.Column="4" 
                                    Content="+" 
                                    FontSize="12"
                                    Padding="0"
                                    Width="24"
                                    Height="24"
                                    Margin="4,0,0,0"
                                    ToolTipService.ToolTip="Aprofundar análise"
                                    Visibility="{x:Bind DeepAnalyzeVisibility, Mode=OneWay}"
                                    Command="{Binding ElementName=RootAnalysisView, Path=ContextViewModel.AnalyzeItemDepthCommand}"
                                    CommandParameter="{x:Bind}"/>

							<ToolTipService.ToolTip>
								<ToolTip Content="{x:Bind FullPath}"/>
							</ToolTipService.ToolTip>
						</Grid>
					</TreeViewItem>
				</DataTemplate>
			</TreeView.ItemTemplate>
		</TreeView>

		<Grid Grid.Row="3" Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
			<Button HorizontalAlignment="Stretch" Style="{StaticResource AccentButtonStyle}" Command="{x:Bind ContextViewModel.CopyContextToClipboardCommand}">
				<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
					<FontIcon Glyph="&#xE8C8;"/>
					<TextBlock Text="Copiar Conteúdo"/>
				</StackPanel>
			</Button>
		</Grid>

		<Grid Grid.RowSpan="4" Background="{ThemeResource LayerFillColorDefaultBrush}" Visibility="{x:Bind ContextViewModel.IsLoading, Mode=OneWay}">
			<ProgressRing IsActive="True" Width="50" Height="50"/>
		</Grid>
	</Grid>
</UserControl>