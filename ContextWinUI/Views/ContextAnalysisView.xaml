<UserControl
    x:Class="ContextWinUI.Views.ContextAnalysisView"
    x:Name="RootAnalysisView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ContextWinUI.Models"
    xmlns:components="using:ContextWinUI.Views.Components"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

	<Grid Background="{ThemeResource LayerFillColorDefaultBrush}">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<Grid Grid.Row="0" Padding="16,12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="Auto"/>
			</Grid.ColumnDefinitions>

			<Button Grid.Column="0" Content="&#xE72B;" FontFamily="Segoe MDL2 Assets"
                    Command="{x:Bind ContextViewModel.GoBackCommand}"
                    Visibility="{x:Bind ContextViewModel.CanGoBack, Mode=OneWay}"
                    Background="Transparent" BorderThickness="0" Margin="0,0,8,0" FontSize="16" Height="32" Width="32"/>

			<StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center">
				<TextBlock Text="Análise de Contexto" Style="{StaticResource SubtitleTextBlockStyle}"/>
				<TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12">
                    <Run Text="Itens Selecionados:"/>
                    <Run Text="{x:Bind ContextViewModel.SelectedCount, Mode=OneWay}"/>
				</TextBlock>
			</StackPanel>

			<components:ExpandCollapseActions Grid.Column="2" 
                                              SyncFocusCommand="{x:Bind ContextViewModel.SyncFocusCommand}"
                                              ExpandAllCommand="{x:Bind ContextViewModel.ExpandAllCommand}"
                                              CollapseAllCommand="{x:Bind ContextViewModel.CollapseAllCommand}"
                                              Margin="0,0,8,0"/>

			<Button Grid.Column="3" Content="✕" Command="{x:Bind ContextViewModel.CloseCommand}" FontSize="16" Width="32" Height="32" Padding="0"/>
		</Grid>

		<Pivot Grid.Row="1">

			<PivotItem Header="Árvore">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>
					<components:SearchBar Grid.Row="0" SearchCommand="{x:Bind ContextViewModel.SearchCommand}" Margin="16,8,16,8"/>
					<TreeView Grid.Row="1"
                              x:Name="AnalysisTreeView"
                              ItemsSource="{x:Bind ContextViewModel.ContextTreeItems, Mode=OneWay}" 
                              SelectionMode="Single"
                              ItemInvoked="TreeView_ItemInvoked">
						<TreeView.ItemTemplate>
							<DataTemplate x:DataType="models:FileSystemItem">
								<TreeViewItem ItemsSource="{x:Bind Children, Mode=OneWay}" IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}" Visibility="{x:Bind Visibility, Mode=OneWay}">
									<TreeViewItem.ContextFlyout>
										<MenuFlyout Opening="OnTagMenuOpening" />
									</TreeViewItem.ContextFlyout>
									<Grid>
										<Grid.ColumnDefinitions>
											<ColumnDefinition Width="Auto"/>
											<ColumnDefinition Width="Auto"/>
											<ColumnDefinition Width="Auto"/>
											<ColumnDefinition Width="*"/>
											<ColumnDefinition Width="Auto"/>
											<ColumnDefinition Width="Auto"/>
										</Grid.ColumnDefinitions>
										<CheckBox Grid.Column="0" IsChecked="{x:Bind IsChecked, Mode=TwoWay}" MinWidth="0" Padding="0" VerticalAlignment="Center" Margin="0,0,8,0"/>
										<FontIcon Grid.Column="1" Glyph="{x:Bind Icon}" FontSize="14" Foreground="{ThemeResource SystemAccentColor}" Margin="0,0,8,0"/>
										<TextBlock Grid.Column="2" Text="{x:Bind Name}" VerticalAlignment="Center" FontSize="13" TextTrimming="CharacterEllipsis"/>
										<components:TagChipsControl Grid.Column="3" TagsSource="{x:Bind SharedState.Tags, Mode=OneWay}" Margin="8,0,0,0" VerticalAlignment="Center"/>
										<Button Grid.Column="4" Content="&#xE768;" FontSize="10" Padding="0" Width="24" Height="24" Margin="8,0,0,0" Visibility="{x:Bind MethodFlowVisibility, Mode=OneWay}" Command="{Binding ElementName=RootAnalysisView, Path=ContextViewModel.AnalyzeMethodFlowCommand}" CommandParameter="{x:Bind}"/>
										<Button Grid.Column="5" Content="+" FontSize="12" Padding="0" Width="24" Height="24" Margin="4,0,0,0" Visibility="{x:Bind DeepAnalyzeVisibility, Mode=OneWay}" Command="{Binding ElementName=RootAnalysisView, Path=ContextViewModel.AnalyzeItemDepthCommand}" CommandParameter="{x:Bind}"/>
										<ToolTipService.ToolTip>
											<ToolTip Content="{x:Bind FullPath}"/>
										</ToolTipService.ToolTip>
									</Grid>
								</TreeViewItem>
							</DataTemplate>
						</TreeView.ItemTemplate>
					</TreeView>
				</Grid>
			</PivotItem>

			<PivotItem Header="Seleção">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>

					<CommandBar Grid.Row="0" DefaultLabelPosition="Right" Background="Transparent" IsOpen="True">
						<AppBarButton Icon="Save" Label="Salvar" Command="{x:Bind ContextViewModel.SelectionVM.SaveSelectionListCommand}"/>
						<AppBarButton Icon="OpenFile" Label="Carregar" Command="{x:Bind ContextViewModel.SelectionVM.LoadSelectionListCommand}"/>
						<AppBarButton Icon="Paste" Label="Importar" Command="{x:Bind ContextViewModel.SelectionVM.ImportFromTextCommand}" CommandParameter="{x:Bind RootAnalysisView.XamlRoot}"/>
						<AppBarButton Icon="Clear" Label="Limpar" Command="{x:Bind ContextViewModel.SelectionVM.ClearCommand}"/>
					</CommandBar>

					<TextBlock Grid.Row="1" Text="Itens marcados:" Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12" Margin="16,4,16,8"/>

					<ListView Grid.Row="2" 
                              x:Name="AnalysisListView"
                              ItemsSource="{x:Bind ContextViewModel.SelectionVM.SelectedItemsList, Mode=OneWay}" 
                              SelectionMode="Extended"
                              IsItemClickEnabled="True"
                              ItemClick="OnListViewItemClick">

						<ListView.ItemTemplate>
							<DataTemplate x:DataType="models:FileSystemItem">
								<Grid Padding="0,4">
									<Grid.ContextFlyout>
										<MenuFlyout Opening="OnTagMenuOpening" />
									</Grid.ContextFlyout>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto"/>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>
									<CheckBox Grid.Column="0" IsChecked="{x:Bind IsChecked, Mode=TwoWay}" MinWidth="0" Margin="0,0,12,0" VerticalAlignment="Center"/>
									<StackPanel Grid.Column="1" VerticalAlignment="Center">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<FontIcon Glyph="{x:Bind Icon}" FontSize="12"/>
											<TextBlock Text="{x:Bind Name}" FontWeight="SemiBold"/>
											<components:TagChipsControl TagsSource="{x:Bind SharedState.Tags, Mode=OneWay}"/>
										</StackPanel>
										<TextBlock Text="{x:Bind FullPath}" FontSize="10" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextTrimming="CharacterEllipsis"/>
									</StackPanel>
									<TextBlock Grid.Column="2" Text="{x:Bind Type}" FontSize="10" Margin="8,0,0,0" VerticalAlignment="Center" Opacity="0.5"/>
								</Grid>
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</Grid>
			</PivotItem>

			<PivotItem Header="Git">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>



					<ListView Grid.Row="1" 
                              x:Name="GitListView" 
                              ItemsSource="{x:Bind ContextViewModel.GitModifiedItems, Mode=OneWay}" 
                              SelectionMode="Extended"
                              IsItemClickEnabled="True"
                              ItemClick="OnListViewItemClick">

						<ListView.ItemTemplate>
							<DataTemplate x:DataType="models:FileSystemItem">
								<Grid Padding="0,4">
									<Grid.ContextFlyout>
										<MenuFlyout Opening="OnTagMenuOpening" />
									</Grid.ContextFlyout>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto"/>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>
									<CheckBox Grid.Column="0" IsChecked="{x:Bind IsChecked, Mode=TwoWay}" MinWidth="0" Margin="0,0,12,0" VerticalAlignment="Center"/>
									<StackPanel Grid.Column="1" VerticalAlignment="Center">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<FontIcon Glyph="{x:Bind Icon}" FontSize="12" Foreground="DarkOrange"/>
											<TextBlock Text="{x:Bind Name}" FontWeight="SemiBold"/>
											<components:TagChipsControl TagsSource="{x:Bind SharedState.Tags, Mode=OneWay}"/>
										</StackPanel>
										<TextBlock Text="{x:Bind FullPath}" FontSize="10" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextTrimming="CharacterEllipsis"/>
									</StackPanel>
									<Border Grid.Column="2" Background="#20FFA500" CornerRadius="4" Padding="6,2" Margin="8,0,0,0">
										<TextBlock Text="MOD" FontSize="9" Foreground="DarkOrange" FontWeight="Bold"/>
									</Border>
								</Grid>
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</Grid>
			</PivotItem>

		</Pivot>

		<Grid Grid.Row="2" Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
			<Button HorizontalAlignment="Stretch" Style="{StaticResource AccentButtonStyle}" Command="{x:Bind ContextViewModel.CopyContextToClipboardCommand}">
				<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
					<FontIcon Glyph="&#xE8C8;"/>
					<TextBlock Text="Copiar Conteúdo Selecionado"/>
				</StackPanel>
			</Button>
		</Grid>

		<Grid Grid.RowSpan="3" Background="{ThemeResource LayerFillColorDefaultBrush}" Visibility="{x:Bind ContextViewModel.IsLoading, Mode=OneWay}">
			<ProgressRing IsActive="True" Width="50" Height="50"/>
		</Grid>
	</Grid>
</UserControl>