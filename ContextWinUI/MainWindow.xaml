<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="ContextWinUI.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ContextWinUI.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="Context WinUI - Explorador de Código">

	<Window.SystemBackdrop>
		<MicaBackdrop />
	</Window.SystemBackdrop>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- Toolbar -->
		<Grid Grid.Row="0" Padding="16,8" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<Button Content="Selecionar Pasta" 
                    Command="{x:Bind ViewModel.FileExplorer.BrowseFolderCommand}"
                    Style="{StaticResource AccentButtonStyle}"/>

			<TextBlock Grid.Column="1" 
                       Text="{x:Bind ViewModel.FileExplorer.CurrentPath, Mode=OneWay}"
                       VerticalAlignment="Center"
                       Margin="16,0,0,0"
                       TextTrimming="CharacterEllipsis"/>
		</Grid>

		<!-- Main Content -->
		<Grid Grid.Row="1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="350" MinWidth="200"/>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*" MinWidth="300"/>
			</Grid.ColumnDefinitions>

			<!-- Tree View -->
			<Grid Grid.Column="0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                  BorderThickness="0,1,1,0">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<TextBlock Grid.Row="0"
                           Text="Arquivos" 
                           Style="{StaticResource SubtitleTextBlockStyle}"
                           Margin="16,12"/>

				<!-- Selection Controls -->
				<Grid Grid.Row="1" Padding="16,8" Background="{ThemeResource LayerFillColorDefaultBrush}">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="*"/>
					</Grid.ColumnDefinitions>

					<Button Content="Selecionar Todos"
                            Command="{x:Bind ViewModel.FileSelection.SelectAllCommand}"
                            Style="{StaticResource AccentButtonStyle}"
                            Margin="0,0,8,0"/>

					<Button Grid.Column="1"
                            Content="Limpar Seleção"
                            Command="{x:Bind ViewModel.FileSelection.UnselectAllCommand}"
                            Margin="0,0,8,0"/>

					<TextBlock Grid.Column="2"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Right"
                               FontSize="12"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                        <Run Text="{x:Bind ViewModel.FileSelection.SelectedFilesCount, Mode=OneWay}"/>
                        <Run Text="selecionado(s)"/>
					</TextBlock>
				</Grid>

				<TreeView Grid.Row="2"
                          ItemsSource="{x:Bind ViewModel.FileExplorer.RootItems, Mode=OneWay}"
                          SelectionMode="Single"
                          ItemInvoked="TreeView_ItemInvoked"
                          Expanding="TreeView_Expanding"
                          Collapsed="TreeView_Collapsed">
					<TreeView.ItemTemplate>
						<DataTemplate x:DataType="models:FileSystemItem">
							<TreeViewItem ItemsSource="{x:Bind Children, Mode=OneWay}"
                                          IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}"
                                          HasUnrealizedChildren="{x:Bind IsDirectory}">
								<StackPanel Orientation="Horizontal" Spacing="8">
									<CheckBox IsChecked="{x:Bind IsChecked, Mode=TwoWay}"
                                              Visibility="{x:Bind IsCodeFile}"
                                              MinWidth="0"
                                              Padding="0"
                                              VerticalAlignment="Center"/>

									<FontIcon Glyph="{x:Bind Icon}" FontSize="16"/>
									<TextBlock Text="{x:Bind Name}" VerticalAlignment="Center"/>
									<TextBlock Text="{x:Bind FileSizeFormatted}" 
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                               FontSize="11"
                                               VerticalAlignment="Center"
                                               Visibility="{x:Bind IsCodeFile}"/>
								</StackPanel>
							</TreeViewItem>
						</DataTemplate>
					</TreeView.ItemTemplate>
				</TreeView>
			</Grid>

			<!-- Splitter -->
			<Border Grid.Column="1" Width="8" Background="Transparent"/>

			<!-- Content Viewer -->
			<Grid Grid.Column="2" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                  BorderThickness="0,1,0,0">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<!-- Content Header -->
				<Grid Padding="16,12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="{x:Bind ViewModel.FileContent.SelectedItem.Name, Mode=OneWay, FallbackValue='Nenhum arquivo selecionado'}"
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               VerticalAlignment="Center"/>

					<Button Grid.Column="1"
                            Content="Analisar Métodos"
                            Command="{x:Bind AnalyzeMethodsCommand}"
                            Margin="0,0,8,0"/>

					<Button Grid.Column="2" 
                            Content="Copiar Arquivo"
                            Command="{x:Bind ViewModel.FileContent.CopyToClipboardCommand}"
                            Margin="0,0,8,0">
						<Button.KeyboardAccelerators>
							<KeyboardAccelerator Key="C" Modifiers="Control"/>
						</Button.KeyboardAccelerators>
					</Button>

					<Button Grid.Column="3" 
                            Content="Copiar Selecionados"
                            Command="{x:Bind ViewModel.FileSelection.CopySelectedFilesCommand}"
                            Style="{StaticResource AccentButtonStyle}">
						<Button.KeyboardAccelerators>
							<KeyboardAccelerator Key="C" Modifiers="Control,Shift"/>
						</Button.KeyboardAccelerators>
					</Button>
				</Grid>

				<!-- Code Content -->
				<ScrollViewer Grid.Row="1" Padding="16">
					<TextBlock Text="{x:Bind ViewModel.FileContent.FileContent, Mode=OneWay}"
                               FontFamily="Cascadia Code, Consolas, Courier New"
                               FontSize="13"
                               IsTextSelectionEnabled="True"
                               TextWrapping="NoWrap"/>
				</ScrollViewer>

				<!-- Loading Indicator -->
				<Grid Grid.Row="1" 
                      Background="{ThemeResource LayerFillColorDefaultBrush}"
                      Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}">
					<ProgressRing IsActive="True" Width="50" Height="50"/>
				</Grid>
			</Grid>

			<!-- Method Analysis Panel -->
			<Grid Grid.Column="2" 
                  Background="{ThemeResource LayerFillColorDefaultBrush}"
                  Visibility="{x:Bind ViewModel.MethodAnalysis.IsVisible, Mode=OneWay}">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="300"/>
					<ColumnDefinition Width="*"/>
				</Grid.ColumnDefinitions>

				<!-- Methods List -->
				<Grid Grid.Column="0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                      BorderThickness="0,0,1,0">
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>

					<Grid Padding="16,12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<TextBlock Text="Métodos Encontrados"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   VerticalAlignment="Center"/>

						<Button Grid.Column="1"
                                Content="✕"
                                Command="{x:Bind ViewModel.MethodAnalysis.CloseCommand}"
                                FontSize="16"
                                Width="32"
                                Height="32"/>
					</Grid>

					<ListView Grid.Row="1"
                              ItemsSource="{x:Bind ViewModel.MethodAnalysis.Methods, Mode=OneWay}"
                              SelectedItem="{x:Bind ViewModel.MethodAnalysis.SelectedMethod, Mode=TwoWay}"
                              SelectionMode="Single">
						<ListView.ItemTemplate>
							<DataTemplate x:DataType="models:MethodInfo">
								<StackPanel Padding="8">
									<TextBlock Text="{x:Bind Name}" 
                                               FontWeight="SemiBold"/>
									<TextBlock Text="{x:Bind DependenciesSummary}"
                                               FontSize="11"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
								</StackPanel>
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</Grid>

				<!-- Method Dependencies -->
				<Grid Grid.Column="1">
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>

					<Grid Padding="16,12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<TextBlock Text="Dependências do Método"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   VerticalAlignment="Center"/>

						<Button Grid.Column="1"
                                Content="Copiar com Dependências"
                                Command="{x:Bind ViewModel.MethodAnalysis.CopyMethodWithDependenciesCommand}"
                                CommandParameter="{x:Bind ViewModel.MethodAnalysis.SelectedMethod, Mode=OneWay}"
                                Style="{StaticResource AccentButtonStyle}"/>
					</Grid>

					<ScrollViewer Grid.Row="1" Padding="16">
						<TextBlock Text="{x:Bind ViewModel.MethodAnalysis.MethodDependenciesText, Mode=OneWay}"
                                   FontFamily="Cascadia Code, Consolas, Courier New"
                                   FontSize="12"
                                   IsTextSelectionEnabled="True"
                                   TextWrapping="Wrap"/>
					</ScrollViewer>
				</Grid>
			</Grid>
		</Grid>

		<!-- Status Bar -->
		<Grid Grid.Row="2" Padding="16,8" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
			<TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                       FontSize="12"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
		</Grid>
	</Grid>
</Window>