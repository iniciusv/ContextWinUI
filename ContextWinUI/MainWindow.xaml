<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="ContextWinUI.MainWindow"
    x:Name="RootWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ContextWinUI.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:ContextWinUI"
    mc:Ignorable="d"
    Title="Context WinUI - Explorador de Código">

	<Window.SystemBackdrop>
		<MicaBackdrop />
	</Window.SystemBackdrop>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<Grid Grid.Row="0" Padding="16,8" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<Button Content="Selecionar Pasta" 
                    Command="{x:Bind ViewModel.FileExplorer.BrowseFolderCommand}"
                    Style="{StaticResource AccentButtonStyle}"/>

			<TextBlock Grid.Column="1" 
                       Text="{x:Bind ViewModel.FileExplorer.CurrentPath, Mode=OneWay}"
                       VerticalAlignment="Center"
                       Margin="16,0,0,0"
                       TextTrimming="CharacterEllipsis"/>
		</Grid>

		<Grid Grid.Row="1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="300" MinWidth="200"/>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="Auto" MinWidth="250"/>
			</Grid.ColumnDefinitions>

			<Grid Grid.Column="0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,1,0">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<TextBlock Grid.Row="0" Text="Arquivos" Style="{StaticResource SubtitleTextBlockStyle}" Margin="16,12"/>

				<Grid Grid.Row="1" Padding="16,8" Background="{ThemeResource LayerFillColorDefaultBrush}">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="*"/>
					</Grid.ColumnDefinitions>
					<Button Content="Selecionar Todos" Command="{x:Bind ViewModel.FileSelection.SelectAllCommand}" Style="{StaticResource AccentButtonStyle}" Margin="0,0,8,0"/>
					<Button Grid.Column="1" Content="Limpar" Command="{x:Bind ViewModel.FileSelection.UnselectAllCommand}" Margin="0,0,8,0"/>
					<TextBlock Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                        <Run Text="{x:Bind ViewModel.FileSelection.SelectedFilesCount, Mode=OneWay}"/>
                        <Run Text="sel."/>
					</TextBlock>
				</Grid>

				<TreeView Grid.Row="2" ItemsSource="{x:Bind ViewModel.FileExplorer.RootItems, Mode=OneWay}" SelectionMode="Single" ItemInvoked="TreeView_ItemInvoked" Expanding="TreeView_Expanding" Collapsed="TreeView_Collapsed">
					<TreeView.ItemTemplate>
						<DataTemplate x:DataType="models:FileSystemItem">
							<TreeViewItem ItemsSource="{x:Bind Children, Mode=OneWay}" IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}" HasUnrealizedChildren="{x:Bind IsDirectory}">
								<StackPanel Orientation="Horizontal" Spacing="8">
									<CheckBox IsChecked="{x:Bind IsChecked, Mode=TwoWay}" Visibility="{x:Bind IsCodeFile}" MinWidth="0" Padding="0" VerticalAlignment="Center"/>
									<FontIcon Glyph="{x:Bind Icon}" FontSize="16"/>
									<TextBlock Text="{x:Bind Name}" VerticalAlignment="Center"/>
									<TextBlock Text="{x:Bind FileSizeFormatted}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="11" VerticalAlignment="Center" Visibility="{x:Bind IsCodeFile}"/>
								</StackPanel>
							</TreeViewItem>
						</DataTemplate>
					</TreeView.ItemTemplate>
				</TreeView>
			</Grid>

			<Border Grid.Column="1" Width="1" Background="{ThemeResource CardStrokeColorDefaultBrush}"/>

			<Grid Grid.Column="2">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<Grid Padding="16,12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="{x:Bind ViewModel.FileContent.SelectedItem.Name, Mode=OneWay, FallbackValue='Nenhum arquivo selecionado'}"
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               VerticalAlignment="Center"/>

					<Button Grid.Column="1" Content="Analisar Contexto" Command="{x:Bind AnalyzeContextCommand}" Style="{StaticResource AccentButtonStyle}" Margin="0,0,8,0"/>

					<Button Grid.Column="2" Content="Copiar Arquivo" Command="{x:Bind ViewModel.FileContent.CopyToClipboardCommand}" Margin="0,0,8,0">
						<Button.KeyboardAccelerators>
							<KeyboardAccelerator Key="C" Modifiers="Control"/>
						</Button.KeyboardAccelerators>
					</Button>

					<Button Grid.Column="3" Content="Copiar Selecionados" Command="{x:Bind ViewModel.FileSelection.CopySelectedFilesCommand}" Style="{StaticResource AccentButtonStyle}">
						<Button.KeyboardAccelerators>
							<KeyboardAccelerator Key="C" Modifiers="Control,Shift"/>
						</Button.KeyboardAccelerators>
					</Button>
				</Grid>

				<Grid Grid.Row="1">
					<ScrollViewer Padding="16">
						<RichTextBlock x:Name="CodeRichTextBlock" FontFamily="Cascadia Code, Consolas, Courier New" FontSize="13" IsTextSelectionEnabled="True" TextWrapping="NoWrap" />
					</ScrollViewer>

					<Grid Background="{ThemeResource LayerFillColorDefaultBrush}" Visibility="{x:Bind ViewModel.FileContent.IsLoading, Mode=OneWay}">
						<ProgressRing IsActive="True" Width="50" Height="50"/>
					</Grid>
				</Grid>
			</Grid>

			<Border Grid.Column="3" Width="1" Background="{ThemeResource CardStrokeColorDefaultBrush}"
                    Visibility="{x:Bind ViewModel.ContextAnalysis.IsVisible, Mode=OneWay}"/>

			<Grid Grid.Column="4" 
                  Width="350"
                  Visibility="{x:Bind ViewModel.ContextAnalysis.IsVisible, Mode=OneWay}"
                  Background="{ThemeResource LayerFillColorDefaultBrush}"
                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                  BorderThickness="0,1,0,0">

				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<Grid Grid.Row="0" Padding="16,12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>
					<StackPanel Orientation="Vertical">
						<TextBlock Text="Análise de Contexto" Style="{StaticResource SubtitleTextBlockStyle}"/>
						<TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12" Margin="0,4,0,0">
                            <Run Text="Selecionados para cópia:"/>
                            <Run Text="{x:Bind ViewModel.ContextAnalysis.SelectedCount, Mode=OneWay}"/>
						</TextBlock>
					</StackPanel>
					<Button Grid.Column="1" Content="✕" Command="{x:Bind ViewModel.ContextAnalysis.CloseCommand}" FontSize="16" Width="32" Height="32" Padding="0"/>
				</Grid>

				<TreeView Grid.Row="1" 
                          ItemsSource="{x:Bind ViewModel.ContextAnalysis.ContextTreeItems, Mode=OneWay}" 
                          SelectionMode="Single"
                          ItemInvoked="ContextTreeView_ItemInvoked">
					<TreeView.ItemTemplate>
						<DataTemplate x:DataType="models:FileSystemItem">
							<TreeViewItem ItemsSource="{x:Bind Children, Mode=OneWay}" IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}">

								<Grid>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto"/>
										<ColumnDefinition Width="Auto"/>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>

									<CheckBox Grid.Column="0" 
                                              IsChecked="{x:Bind IsChecked, Mode=TwoWay}" 
                                              Command="{Binding ElementName=RootWindow, Path=ViewModel.ContextAnalysis.ItemCheckedCommand}"
                                              MinWidth="0" Padding="0" VerticalAlignment="Center" Margin="0,0,8,0"/>

									<FontIcon Grid.Column="1" Glyph="{x:Bind Icon}" FontSize="14" Foreground="{ThemeResource SystemAccentColor}" Margin="0,0,8,0"/>

									<TextBlock Grid.Column="2" Text="{x:Bind Name}" VerticalAlignment="Center" FontSize="13" TextTrimming="CharacterEllipsis"/>

									<Button Grid.Column="3" 
                                            Content="+" 
                                            FontSize="12"
                                            Padding="0"
                                            Width="24"
                                            Height="24"
                                            Margin="8,0,0,0"
                                            ToolTipService.ToolTip="Aprofundar análise (carregar dependências deste item)"
                                            Visibility="{x:Bind DeepAnalyzeVisibility, Mode=OneWay}"
                                            Command="{Binding ElementName=RootWindow, Path=ViewModel.ContextAnalysis.AnalyzeItemDepthCommand}"
                                            CommandParameter="{Binding}"/>

									<ToolTipService.ToolTip>
										<ToolTip Content="{x:Bind FullPath}"/>
									</ToolTipService.ToolTip>
								</Grid>
							</TreeViewItem>
						</DataTemplate>
					</TreeView.ItemTemplate>
				</TreeView>

				<Grid Grid.Row="2" Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
					<Button HorizontalAlignment="Stretch" Style="{StaticResource AccentButtonStyle}" Command="{x:Bind ViewModel.ContextAnalysis.CopyContextToClipboardCommand}">
						<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
							<FontIcon Glyph="&#xE8C8;"/>
							<TextBlock Text="Copiar Conteúdo"/>
						</StackPanel>
					</Button>
				</Grid>

				<Grid Grid.RowSpan="3" Background="{ThemeResource LayerFillColorDefaultBrush}" Visibility="{x:Bind ViewModel.ContextAnalysis.IsLoading, Mode=OneWay}">
					<ProgressRing IsActive="True" Width="50" Height="50"/>
				</Grid>
			</Grid>
		</Grid>

		<Grid Grid.Row="2" Padding="16,8" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
			<TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                       FontSize="12"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
		</Grid>
	</Grid>
</Window>